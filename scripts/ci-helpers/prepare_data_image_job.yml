include:
  - project: 'hive/hive'
    ref: develop
    file: '/scripts/ci-helpers/prepare_data_image_job.yml' 

.prepare_haf_data_5m_image:
  extends: .docker_image_builder_job

  variables:
    SUBMODULE_DIR: "$CI_PROJECT_DIR/haf"
    REGISTRY_USER: "$CI_IMG_BUILDER_USER"
    REGISTRY_PASS: $CI_IMG_BUILDER_PASSWORD

    SCRIPTS_PATH: "$SUBMODULE_DIR/scripts"
  script:
    - $SCRIPTS_PATH/ci-helpers/get_image4submodule.sh "$SUBMODULE_DIR" registry.gitlab.syncad.com/hive/haf/ "HAF_IMAGE_NAME" "$REGISTRY_USER" "$REGISTRY_PASS" "hived-binaries"

  artifacts:
    reports:
      dotenv: docker_image_name.env

    expire_in: 6 hours

.prepare_haf_image:
  extends: .docker_image_builder_job

  variables:
    SUBMODULE_DIR: "$CI_PROJECT_DIR"
    SCRIPTS_PATH: "$SUBMODULE_DIR/scripts"
    REGISTRY_USER: "$CI_IMG_BUILDER_USER"
    REGISTRY_PASS: $CI_IMG_BUILDER_PASSWORD
    BINARY_CACHE_PATH: "hived-binaries"
    HIVE_NETWORK_TYPE: mainnet
  script:
    - echo "HOSTNAME is ${HOSTNAME} CI_CONCURRENT_ID ${CI_CONCURRENT_ID}"
    - $SCRIPTS_PATH/ci-helpers/get_image4submodule2.sh
        "$SUBMODULE_DIR" registry.gitlab.syncad.com/hive/haf/ "HAF_IMAGE_NAME" "$REGISTRY_USER" "$REGISTRY_PASS"
        --export-binaries="$BINARY_CACHE_PATH" --network-type="$HIVE_NETWORK_TYPE"
    - ls -la ./$BINARY_CACHE_PATH/*

  artifacts:
    reports:
      dotenv: docker_image_name.env
    paths:
      - ./$BINARY_CACHE_PATH/*
      - ./docker_image_name.env
    expire_in: 6 hours

.prepare_haf_data_5m:
  extends: .docker_image_builder_job

  variables:
    SUBMODULE_DIR: "$CI_PROJECT_DIR"
    SCRIPTS_PATH: "$SUBMODULE_DIR/scripts"
    BLOCK_LOG_SOURCE_DIR: ""
    CONFIG_INI_SOURCE: ""
    DATA_CACHE: $DATA_CACHE_MAINNET
    HIVE_NETWORK_TYPE: mainnet
  script:
    - echo "HOSTNAME is ${HOSTNAME} CI_CONCURRENT_ID ${CI_CONCURRENT_ID}"
    - $SCRIPTS_PATH/ci-helpers/build_data2.sh $HAF_IMAGE_NAME
        --data-cache="$DATA_CACHE" --block-log-source-dir="$BLOCK_LOG_SOURCE_DIR" --config-ini-source="$CONFIG_INI_SOURCE"
    - echo "cache usage:"
    - du -h -d 1 /cache || true
    - cp $DATA_CACHE/datadir/docker_entrypoint.log $CI_PROJECT_DIR
    - echo "HIVED_UID=$(id -u)" > hived_uid.env
    - cat hived_uid.env

  artifacts:
    reports:
      dotenv:
        - docker_image_name.env
        - hived_uid.env
    paths:
    - docker_entrypoint.log
    expire_in: 6 hours
